#!/usr/bin/env python

import roslib
roslib.load_manifest('pr2_mechanism_controllers')
roslib.load_manifest('mechanism_control')
roslib.load_manifest('mechanism_bringup')

import rospy

from robot_msgs.msg import JointTraj, JointTrajPoint
from mechanism_control import mechanism
from robot_mechanism_controllers.srv import *

import sys
from time import sleep

def move(positions):
  pub = rospy.Publisher('right_arm/trajectory_controller/trajectory_command', JointTraj)

  # HACK
  sleep(2)

  msg = JointTraj()
  msg.points = []
  for i in range(0,len(positions)):
    msg.points.append(JointTrajPoint())
    msg.points[i].positions = positions[i]
    msg.points[i].time = 0.0

  pub.publish(msg)
  
def set_params():
  rospy.set_param("right_arm/trajectory_controller/velocity_scaling_factor", 0.75)
  rospy.set_param("right_arm/trajectory_controller/trajectory_wait_timeout", 0.25)

  rospy.set_param("right_arm/trajectory_controller/r_shoulder_pan_joint/goal_reached_threshold", 0.1)
  rospy.set_param("right_arm/trajectory_controller/r_shoulder_lift_joint/goal_reached_threshold", 0.1)
  rospy.set_param("right_arm/trajectory_controller/r_shoulder_roll_joint/goal_reached_threshold", 0.1)
  rospy.set_param("right_arm/trajectory_controller/r_elbow_flex_joint/goal_reached_threshold", 0.1)
  rospy.set_param("right_arm/trajectory_controller/r_forearm_roll_joint/goal_reached_threshold", 0.1)
  rospy.set_param("right_arm/trajectory_controller/r_wrist_flex_joint/goal_reached_threshold", 0.1)
  rospy.set_param("right_arm/trajectory_controller/r_wrist_roll_joint/goal_reached_threshold", 0.1)  
  
if __name__ == '__main__':

  rospy.wait_for_service('spawn_controller')
  rospy.init_node('move_to_pickup', anonymous = True)

  # Load xml file for arm trajectory controllers
  path = roslib.packages.get_pkg_dir('sbpl_arm_executive')

  xml_for_right = open(path + '/launch/xml/r_arm_trajectory_controller.xml')

  controllers = []
  try:

    # tuck traj for left arm
    set_params()
    mechanism.spawn_controller(xml_for_right.read())
    controllers.append('right_arm/trajectory_controller')

    positions = [[-0.0169115133318, 1.4054003652, -1.49847441109, -2.05145619713, -0.0319894340348, 0.0976998796058, -0.00781787891648],
                  [-0.0169115133318, 1.4054003652, -1.49991771552, -2.05160095765, -0.0319894340348, 0.0994402372362, -0.00955823654684],
                  [-0.0169115133318, 1.4054003652, -1.50007808268, -2.05160095765, -0.0319894340348, 0.100701996518, -0.0108199958289],
                  [-0.0169115133318, 1.4054003652, -1.50007808268, -2.05189047867, -0.0319894340348, 0.110622035011, -0.0205659985589],
                  [-0.0169115133318, 1.4054003652, -1.50007808268, -2.05189047867, -0.0319894340348, 0.137336524637, -0.0383176463886],
                  [-0.0169115133318, 1.4054003652, -1.49991771552, -2.05189047867, -0.0319894340348, 0.189373217785, -0.0491948815784],
                  [-0.0169115133318, 1.4054003652, -1.49959698121, -2.05189047867, -0.0319894340348, 0.263338417076, -0.0373604496919],
                  [-0.0169115133318, 1.4054003652, -1.49847441109, -2.05189047867, -0.0319894340348, 0.348702958845, -0.0133435143929],
                  [-0.0170773140841, 1.4054003652, -1.49799330961, -2.05232476021, -0.0319894340348, 0.431152401584, 0.00793235763832],
                  [-0.0178234174692, 1.4054003652, -1.49687073949, -2.05246952072, -0.0319894340348, 0.498286697175, 0.0108474566692],
                  [-0.0208907313858, 1.4054003652, -1.49077678744, -2.05348284432, -0.0319894340348, 0.539663699837, 0.000970927116861],
                  [-0.029097868622, 1.4054003652, -1.47923035196, -2.05435140739, -0.0319894340348, 0.564420287129, -0.0205659985589],
                  [-0.0922679552284, 1.4054003652, -1.48323953094, -2.05435140739, -0.0319894340348, 0.661619260784, -0.0507612034457],
                  [-0.117718370698, 1.4054003652, -1.48564503833, -2.05435140739, -0.0319894340348, 0.717267196015, -0.0410587096564],
                  [-0.144329391434, 1.4054003652, -1.48628650697, -2.05435140739, -0.0319894340348, 0.771479336201, -0.0291372598884],
                  [-0.173427423454, 1.4054003652, -1.48644687413, -2.05435140739, -0.0319894340348, 0.819861278325, -0.0214796863148],
                  [-0.206753374655, 1.4054003652, -1.48885238152, -2.05435140739, -0.0319894340348, 0.859845994883, -0.0192607303361],
                  [-0.251519577762, 1.4054003652, -1.49799330961, -2.05435140739, -0.0319894340348, 0.899482639914, -0.0200874002105],
                  [-0.29263816432, 1.4054003652, -1.511464151, -2.05435140739, -0.0319894340348, 0.92963433586, -0.0236986422935],
                  [-0.336658264042, 1.4054003652, -1.52846306991, -2.05435140739, -0.0319894340348, 0.966529917624, -0.0282235721325],
                  [-0.382502172038, 1.4054003652, -1.54466015301, -2.05449616791, -0.0319894340348, 1.01525993127, -0.0279625184879],
                  [-0.428843482291, 1.4054003652, -1.55668768997, -2.05449616791, -0.0319894340348, 1.07230015261, -0.0281800631917],
                  [-0.475018991792, 1.4054003652, -1.56630971954, -2.05449616791, -0.0319894340348, 1.12220490766, -0.0256130356869],
                  [-0.519204892266, 1.4054003652, -1.57336587455, -2.05449616791, -0.0319894340348, 1.1521390589, -0.0262221608576],
                  [-0.557753567164, 1.4054003652, -1.57480917899, -2.05449616791, -0.0319894340348, 1.16436507126, -0.0280060274287],
                  [-0.594063931906, 1.40531576369, -1.57480917899, -2.05449616791, -0.0319894340348, 1.17219668059, -0.0316607784525],
                  [-0.630042695144, 1.40531576369, -1.57480917899, -2.05435140739, -0.0319894340348, 1.18542339858, -0.0402755487228],
                  [-0.666933362519, 1.40531576369, -1.57480917899, -2.05435140739, -0.0319894340348, 1.21914282767, -0.0604201882942],
                  [-0.704818834408, 1.40531576369, -1.57480917899, -2.05406188637, -0.0319894340348, 1.2816216666, -0.0866995885127],
                  [-0.741460800654, 1.40531576369, -1.57480917899, -2.05362760483, -0.0319894340348, 1.36624655638, -0.103624566468],
                  [-0.774372249976, 1.40523116217, -1.57448844467, -2.05362760483, -0.0319894340348, 1.45200267861, -0.103668075409],
                  [-0.802475477482, 1.40523116217, -1.57208293728, -2.05362760483, -0.0319894340348, 1.53597493428, -0.0869606421573],
                  [-0.824361176778, 1.40523116217, -1.56711155533, -2.05377236534, -0.0319894340348, 1.60741661501, -0.0473675060665],
                  [-0.842018956893, 1.40523116217, -1.56326274351, -2.05377236534, -0.0319894340348, 1.66937334665, 0.0133709752332],
                  [-0.856692323467, 1.40523116217, -1.55861209588, -2.05377236534, -0.0319894340348, 1.73106902464, 0.0750666532296],
                  [-0.869541881766, 1.40523116217, -1.54802786336, -2.05377236534, -0.0319894340348, 1.77932043994, 0.123318068531],
                  [-0.883552045331, 1.40523116217, -1.53102894446, -2.05377236534, -0.0319894340348, 1.81652058429, 0.155645211515],
                  [-0.901707227702, 1.40523116217, -1.50889827645, -2.05377236534, -0.0319894340348, 1.86089970387, 0.169742108321],
                  [-0.930390757841, 1.40523116217, -1.48243769514, -2.05377236534, -0.0319894340348, 1.91132656621, 0.174310547101],
                  [-0.959322989108, 1.40523116217, -1.45581674668, -2.05406188637, -0.0319894340348, 1.91715676427, 0.176224940494],
                  [-0.995053051217, 1.40523116217, -1.43144093844, -2.05406188637, -0.0319894340348, 1.91715676427, 0.176224940494],
                  [-1.04114566034, 1.40523116217, -1.42037560444, -2.05406188637, -0.0319894340348, 1.91715676427, 0.176224940494],
                  [-1.09768371686, 1.40523116217, -1.41909266716, -2.05406188637, -0.0319894340348, 1.91720027321, 0.176268449435],
                  [-1.16035640121, 1.40523116217, -1.41909266716, -2.05406188637, -0.0319894340348, 1.91807045203, 0.17713862825],
                  [-1.2260134991, 1.40523116217, -1.4197341358, -2.05406188637, -0.0319894340348, 1.91850554143, 0.177573717658],
                  [-1.29175349736, 1.40523116217, -1.42069633876, -2.05319332329, -0.0319894340348, 1.91859255931, 0.17766073554],
                  [-1.35666449187, 1.40523116217, -1.42117744023, -2.05261428124, -0.0319894340348, 1.91946273813, 0.178530914355],
                  [-1.42016617998, 1.40523116217, -1.42117744023, -2.0521799997, -0.0319894340348, 1.91963677389, 0.178704950118],
                  [-1.48200986057, 1.40523116217, -1.42117744023, -2.05203523919, -0.0318158928014, 1.91963677389, 0.178704950118],
                  [-1.54070332686, 1.40514656066, -1.42085670592, -2.05203523919, -0.0289813859882, 1.91963677389, 0.178704950118],
                  [-1.59052645291, 1.40514656066, -1.42085670592, -2.05203523919, -0.0141146869882, 1.91963677389, 0.178704950118],
                  [-1.63214244173, 1.40506195914, -1.4205359716, -2.05116667611, 0.0455834973227, 1.91472026359, 0.183621460424],
                  [-1.66745800196, 1.40506195914, -1.4189323, -2.05058763406, 0.153179062069, 1.89918757174, 0.199154152275],
                  [-1.69697053586, 1.40506195914, -1.41043284055, -2.05029811303, 0.296639815064, 1.87704152089, 0.221300203121],
                  [-1.72076294381, 1.40506195914, -1.38477409504, -2.05015335252, 0.452248454402, 1.85332914818, 0.245012575835],
                  [-1.73792332166, 1.40506195914, -1.34740854689, -2.05015335252, 0.610922988864, 1.83109607945, 0.267245644562],
                  [-1.74654496078, 1.40506195914, -1.30988263158, -2.05116667611, 0.771853559361, 1.82383008634, 0.274511637669],
                  [-1.74745686492, 1.40506195914, -1.28181837867, -2.05174571816, 0.930643787979, 1.82383008634, 0.274511637669],
                  [-1.74745686492, 1.40506195914, -1.27428112218, -2.05189047867, 1.08908693413, 1.82383008634, 0.274511637669],
                  [-1.74637916003, 1.40506195914, -1.27636589525, -2.0533380838, 1.23642344134, 1.82383008634, 0.274511637669],
                  [-1.74472115251, 1.40514656066, -1.28117691004, -2.0533380838, 1.31908691554, 1.82383008634, 0.274511637669],
                  [-1.74298024461, 1.40514656066, -1.28823306505, -2.0533380838, 1.35500995087, 1.82383008634, 0.274511637669],
                  [-1.74273154348, 1.4054003652, -1.29977950053, -2.0533380838, 1.37195914467, 1.81965322803, 0.270334779356],
                  [-1.74273154348, 1.40616177884, -1.31132593601, -2.05319332329, 1.39862664755, 1.79694156095, 0.24762311228],
                  [-1.74273154348, 1.4065001849, -1.31822172387, -2.05319332329, 1.442821815, 1.76265651563, 0.213338066962],
                  [-1.74273154348, 1.4065001849, -1.3196650283, -2.05304856278, 1.4720345893, 1.74921225294, 0.199893804267],
                  [-1.74273154348, 1.4065001849, -1.3196650283, -2.05290380226, 1.4806538039, 1.74921225294, 0.199893804267],
                  [-1.7426486431, 1.4065001849, -1.3196650283, -2.05290380226, 1.48071165098, 1.74921225294, 0.199893804267],
                  [-1.74248284235, 1.4065001849, -1.31998576262, -2.05290380226, 1.48146366299, 1.74921225294, 0.199893804267],
                  [-1.74239994197, 1.40641558338, -1.31998576262, -2.05290380226, 1.48152151007, 1.74921225294, 0.199893804267] ]  
    move(positions)

    rospy.spin()
    
  finally:
    for name in controllers:
      try:
        mechanism.kill_controller(name)
      except:
        pass
